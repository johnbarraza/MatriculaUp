---
phase: 01-extraction-pipeline-fix-validation
plan: 04
type: execute
wave: 3
depends_on: [01-02, 01-03]
files_modified:
  - scripts/extractors/validators.py
autonomous: true
requirements: [EXT-04]

must_haves:
  truths:
    - "pytest tests/test_validation.py -x exits 0 (all schema compliance tests GREEN)"
    - "validate_courses_json(loaded_courses_json) returns [] for the real input/courses_2026-1.json"
    - "validate_curriculum_json(loaded_curricula_json) returns [] for input/curricula_economia2017.json"
    - "python scripts/extract.py --type courses exits with code 1 if >1% error rate and code 0 if <1%"
  artifacts:
    - path: "scripts/extractors/validators.py"
      provides: "validate_courses_json() and validate_curriculum_json() using jsonschema"
      exports: ["validate_courses_json", "validate_curriculum_json", "COURSES_SCHEMA", "CURRICULUM_SCHEMA"]
  key_links:
    - from: "scripts/extractors/courses.py"
      to: "scripts/extractors/validators.py"
      via: "validate_courses_json called before save() in CourseOfferingExtractor.extract()"
      pattern: "validate_courses_json"
    - from: "scripts/extractors/curriculum.py"
      to: "scripts/extractors/validators.py"
      via: "validate_curriculum_json called before save() in CurriculumExtractor.extract()"
      pattern: "validate_curriculum_json"
    - from: "tests/test_validation.py"
      to: "scripts/extractors/validators.py"
      via: "from scripts.extractors.validators import validate_courses_json, validate_curriculum_json"
      pattern: "from scripts.extractors.validators"
---

<objective>
Implement JSON schema validators for both output files and wire them into the extraction pipeline. This is the final quality gate: real extracted JSON must pass schema validation.

Purpose: EXT-04 requires the extracted JSON to be validated against a defined schema. This plan implements validators.py and verifies actual output against it.
Output: scripts/extractors/validators.py + both extractors updated to call validation before saving
</objective>

<execution_context>
@C:/Users/johnb/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/johnb/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-extraction-pipeline-fix-validation/01-CONTEXT.md
@.planning/phases/01-extraction-pipeline-fix-validation/01-RESEARCH.md
@.planning/phases/01-extraction-pipeline-fix-validation/01-02-SUMMARY.md
@.planning/phases/01-extraction-pipeline-fix-validation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement validators.py with jsonschema</name>
  <files>
    scripts/extractors/validators.py
  </files>
  <action>
Create `scripts/extractors/validators.py` with full schema definitions and validation functions.

The schema must match the locked decisions from CONTEXT.md: `curso → secciones[] → sesiones[]`.

```python
"""
JSON Schema validators for MatriculaUp extraction output.
Uses jsonschema library for declarative schema validation.
"""
from jsonschema import validate, ValidationError, Draft7Validator
from typing import List
import logging

logger = logging.getLogger(__name__)

# ─── Courses Schema ───────────────────────────────────────────────────────────

SESSION_SCHEMA = {
    "type": "object",
    "properties": {
        "tipo": {
            "type": "string",
            "enum": ["CLASE", "PRÁCTICA", "FINAL", "PARCIAL", "PRACDIRIGIDA",
                     "PRACCALIFICADA", "CANCELADA", "LABORATORIO", "TALLER"]
        },
        "dia": {"type": "string", "minLength": 2},
        "hora_inicio": {"type": "string", "pattern": r"^\d{2}:\d{2}$"},
        "hora_fin": {"type": "string", "pattern": r"^\d{2}:\d{2}$"},
        "aula": {"type": ["string", "null"]},
    },
    "required": ["tipo", "dia", "hora_inicio", "hora_fin"],
}

SECTION_SCHEMA = {
    "type": "object",
    "properties": {
        "seccion": {"type": "string", "minLength": 1},
        "docentes": {"type": "array", "items": {"type": "string"}},
        "observaciones": {"type": ["string", "null"]},
        "sesiones": {"type": "array", "items": SESSION_SCHEMA, "minItems": 0},
    },
    "required": ["seccion", "sesiones"],
}

PREREQUISITE_SCHEMA = {
    "oneOf": [
        {"type": "null"},
        {"type": "string"},
        {
            "type": "object",
            "properties": {
                "raw": {"type": "string"},
                "parsed": {"type": "boolean", "enum": [False]},
            },
            "required": ["raw", "parsed"],
        },
        {
            "type": "object",
            "properties": {
                "op": {"type": "string", "enum": ["AND", "OR"]},
                "items": {"type": "array"},
            },
            "required": ["items"],
        },
    ]
}

COURSE_SCHEMA = {
    "type": "object",
    "properties": {
        "codigo": {"type": "string", "pattern": r"^\d{6}$"},
        "nombre": {"type": "string", "minLength": 1},
        "creditos": {"type": ["string", "number", "null"]},
        "prerequisitos": PREREQUISITE_SCHEMA,
        "secciones": {"type": "array", "items": SECTION_SCHEMA},
    },
    "required": ["codigo", "nombre", "creditos", "secciones"],
}

COURSES_SCHEMA = {
    "type": "object",
    "properties": {
        "metadata": {
            "type": "object",
            "properties": {
                "ciclo": {"type": "string"},
                "fecha_extraccion": {"type": "string"},
            },
            "required": ["ciclo", "fecha_extraccion"],
        },
        "cursos": {
            "type": "array",
            "items": COURSE_SCHEMA,
            "minItems": 1,
        },
    },
    "required": ["metadata", "cursos"],
}

# ─── Curriculum Schema ────────────────────────────────────────────────────────

CURRICULUM_COURSE_SCHEMA = {
    "type": "object",
    "properties": {
        "codigo": {"type": "string"},
        "nombre": {"type": "string"},
        "creditos": {"type": ["string", "number", "null"]},
        "tipo": {"type": "string", "enum": ["obligatorio", "electivo", "other"]},
    },
    "required": ["codigo", "nombre"],
}

CICLO_SCHEMA = {
    "type": "object",
    "properties": {
        "ciclo": {"type": ["integer", "number"], "minimum": 1},
        "cursos": {"type": "array", "items": CURRICULUM_COURSE_SCHEMA, "minItems": 1},
    },
    "required": ["ciclo", "cursos"],
}

CURRICULUM_SCHEMA = {
    "type": "object",
    "properties": {
        "metadata": {
            "type": "object",
            "properties": {
                "plan": {"type": "string"},
                "carrera": {"type": "string"},
                "fecha_extraccion": {"type": "string"},
            },
            "required": ["plan", "carrera", "fecha_extraccion"],
        },
        "ciclos": {
            "type": "array",
            "items": CICLO_SCHEMA,
            "minItems": 1,
        },
    },
    "required": ["metadata", "ciclos"],
}

# ─── Validator Functions ──────────────────────────────────────────────────────

def validate_courses_json(data: dict) -> List[str]:
    """
    Validate courses extraction output against COURSES_SCHEMA.
    Returns list of error messages (empty list = valid).
    """
    validator = Draft7Validator(COURSES_SCHEMA)
    errors = sorted(validator.iter_errors(data), key=lambda e: list(e.path))
    if not errors:
        return []
    return [f"{'.'.join(str(p) for p in e.path)}: {e.message}" for e in errors]


def validate_curriculum_json(data: dict) -> List[str]:
    """
    Validate curriculum extraction output against CURRICULUM_SCHEMA.
    Returns list of error messages (empty list = valid).
    """
    validator = Draft7Validator(CURRICULUM_SCHEMA)
    errors = sorted(validator.iter_errors(data), key=lambda e: list(e.path))
    if not errors:
        return []
    return [f"{'.'.join(str(p) for p in e.path)}: {e.message}" for e in errors]
```

After writing validators.py, update `scripts/extractors/courses.py` to call validation before saving:
- In `CourseOfferingExtractor.extract()`, after building the `data` dict, call:
  ```python
  from scripts.extractors.validators import validate_courses_json
  errors = validate_courses_json(data)
  if errors:
      for e in errors[:5]:  # Show first 5 errors
          logger.warning(f"Schema error: {e}")
      print(f"⚠  {len(errors)} schema validation errors")
  else:
      print("✓ Schema validation passed")
  ```

Similarly update `scripts/extractors/curriculum.py` to call `validate_curriculum_json`.
  </action>
  <verify>
    <automated>cd C:/Users/johnb/Documents/GitHub/MatriculaUp && pytest tests/test_validation.py -x --tb=short -q</automated>
    <manual>Confirm TestJsonSchemaCompliance tests are GREEN — not skipped, actually passing</manual>
  </verify>
  <done>tests/test_validation.py passes GREEN; validate_courses_json and validate_curriculum_json exported from scripts/extractors/validators.py</done>
</task>

<task type="auto">
  <name>Task 2: Validate real output files and run full test suite</name>
  <files>
    (no new files — validates existing input/*.json)
  </files>
  <action>
Validate both generated JSON files against the schema and run the full test suite.

Run validation against real output:
```bash
cd C:/Users/johnb/Documents/GitHub/MatriculaUp
python -c "
import json
from scripts.extractors.validators import validate_courses_json, validate_curriculum_json

# Validate courses
with open('input/courses_2026-1.json', encoding='utf-8') as f:
    courses = json.load(f)
errors = validate_courses_json(courses)
if errors:
    print(f'courses_2026-1.json: {len(errors)} errors')
    for e in errors[:10]:
        print(f'  {e}')
else:
    print(f'courses_2026-1.json: VALID ({len(courses[\"cursos\"])} cursos)')

# Validate curriculum
with open('input/curricula_economia2017.json', encoding='utf-8') as f:
    curriculum = json.load(f)
errors = validate_curriculum_json(curriculum)
if errors:
    print(f'curricula_economia2017.json: {len(errors)} errors')
    for e in errors[:10]:
        print(f'  {e}')
else:
    print(f'curricula_economia2017.json: VALID ({len(curriculum[\"ciclos\"])} ciclos)')
"
```

If validation errors appear in courses_2026-1.json or curricula_economia2017.json:
- Identify which fields are causing schema failures
- If it is a schema issue (field valid but schema too strict — e.g., enum missing a session type that actually appears), update the schema in validators.py to match reality
- If it is a data issue (extractor producing wrong field names or malformed data), fix the extractor in courses.py or curriculum.py and re-run extraction
- Prioritize: real data wins over strict schema assumptions. Schema must describe what the PDF actually contains, not an idealized structure.

After fixing any schema/data mismatches, run the full test suite:
```bash
cd C:/Users/johnb/Documents/GitHub/MatriculaUp && pytest tests/ -v --tb=short
```

All tests must pass GREEN. Report final counts: X passed, 0 failed.
  </action>
  <verify>
    <automated>cd C:/Users/johnb/Documents/GitHub/MatriculaUp && pytest tests/ -v --tb=short -q 2>&1 | tail -10</automated>
    <manual>
      Confirm in output:
      1. "courses_2026-1.json: VALID (N cursos)" — N > 50
      2. "curricula_economia2017.json: VALID (M ciclos)" — M >= 5
      3. pytest summary shows 0 failures
    </manual>
  </verify>
  <done>
    - validate_courses_json(courses_2026-1.json) returns []
    - validate_curriculum_json(curricula_economia2017.json) returns []
    - pytest tests/ exits 0 with 0 failures
    - Phase 1 extraction pipeline is complete
  </done>
</task>

</tasks>

<verification>
Full phase verification:
```bash
cd C:/Users/johnb/Documents/GitHub/MatriculaUp
pytest tests/ -v --tb=short
python -c "
import json
from scripts.extractors.validators import validate_courses_json, validate_curriculum_json
c = json.load(open('input/courses_2026-1.json', encoding='utf-8'))
cu = json.load(open('input/curricula_economia2017.json', encoding='utf-8'))
assert validate_courses_json(c) == [], 'courses schema invalid'
assert validate_curriculum_json(cu) == [], 'curriculum schema invalid'
print('ALL PHASE 1 VALIDATIONS PASSED')
print(f'  courses: {len(c[\"cursos\"])} cursos')
print(f'  curriculum: {len(cu[\"ciclos\"])} ciclos, {sum(len(x[\"cursos\"]) for x in cu[\"ciclos\"])} total courses')
"
```
</verification>

<success_criteria>
- scripts/extractors/validators.py exists with validate_courses_json and validate_curriculum_json
- Both functions return [] when called with real input/*.json files
- pytest tests/ exits 0 — 0 failures across all 15+ tests
- Phase 1 all 5 requirements satisfied:
  - EXT-01: courses_2026-1.json generated with full course/section/session structure
  - EXT-02: No truncated prerequisites in output
  - EXT-03: Compound Spanish surnames captured in full
  - EXT-04: Both JSON files pass schema validation
  - EXT-05: curricula_economia2017.json generated with ciclos structure
</success_criteria>

<output>
After completion, create `.planning/phases/01-extraction-pipeline-fix-validation/01-04-SUMMARY.md`
</output>
