---
phase: 2
plan: 4
wave: 3
depends_on: [2, 3]
files_modified:
  - "src/matriculaup/ui/app_window.py"
  - "src/matriculaup/store/state.py"
  - "src/matriculaup/ui/tabs/search_tab.py"
  - "src/matriculaup/ui/tabs/schedule_tab.py"
autonomous: true
must_haves:
  truths:
    - "Sections added in Tab 1 appear in Tab 2"
  artifacts:
    - "Connected state"
---

# Plan 2.4: Integration & State

<objective>
Connect all previous pieces into a functional application.
</objective>

<context>
Load for context:
- src/matriculaup/ui/app_window.py
- src/matriculaup/store/persistence.py
</context>

<tasks>

<task type="auto">
  <name>Global App State</name>
  <files>src/matriculaup/store/state.py</files>
  <action>
    Create a centralized state controller `ScheduleState` using PySide6 `QObject` and `Signal` that holds the list of currently selected `Section`s.
    Emits `on_sections_changed()` when a section is added or removed.
  </action>
  <verify>Unit test to ensure signals work when list changes.</verify>
  <done>State successfully isolates data logic from the UI instances.</done>
</task>

<task type="auto">
  <name>State Wiring</name>
  <files>src/matriculaup/ui/app_window.py, src/matriculaup/ui/tabs/search_tab.py, src/matriculaup/ui/tabs/schedule_tab.py</files>
  <action>
    Make "Add to Schedule" action in Search tree update the `ScheduleState`.
    Make `schedule_tab` subscribe to `on_sections_changed()` and call `conflict_detector`. If conflicts exist, show a visual warning label; otherwise draw on `timetable_grid`.
    Add a mechanism (e.g., right-click block or remove button) to remove a section from state.
    Use `persistence.py` to auto-save after `on_sections_changed()` and auto-load at startup.
  </action>
  <verify>Launch app, add a section, close app, reopen. Section should still be in the grid.</verify>
  <done>End-to-end integration works seamlessly.</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] Add/remove works
- [ ] Saves correctly to AppData
- [ ] Valid states display normally, conflicting states show warning
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
