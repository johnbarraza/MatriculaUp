---
phase: 6
plan: 2
wave: 2
depends_on: ["06-01"]
files_modified: ["matriculaup_app/lib/store/schedule_state.dart", "matriculaup_app/lib/ui/components/course_search_list.dart"]
autonomous: false
must_haves:
  truths:
    - "The app prevents the user from adding the same course twice."
    - "The app warns the user visually (red tint or icon) in the search list if a section overlaps with currently selected sections."
    - "Overlapping sections are either blocked from adding or invoke a clear warning dialog/snackbar."
  artifacts:
    - "matriculaup_app/lib/store/schedule_state.dart"
---

# Plan 6.2: Conflict Prevention & Validation

<objective>
Enhance the scheduling logic to prevent invalid states. This ensures the user cannot add duplicate courses and gets visual feedback *before* attempting to add a section that conflicts with their current schedule.
</objective>

<context>
Load for context:
- `matriculaup_app/lib/store/schedule_state.dart`
- `matriculaup_app/lib/ui/components/course_search_list.dart`
</context>

<tasks>

<task type="auto">
  <name>Implement Duplicate Course Prevention</name>
  <files>matriculaup_app/lib/store/schedule_state.dart</files>
  <action>
    Modify `addSection` to throw an exception or return a boolean/status if the user tries to add a section for a `Course` that is already in `selectedSections` (matching by `codigo`).
    Update the UI (in the add button callback) to catch this and show a `SnackBar` via `ScaffoldMessenger` saying "El curso ya está en el horario."
  </action>
  <verify>Check state logic for course code matching.</verify>
  <done>User cannot add two different sections of the same course.</done>
</task>

<task type="auto">
  <name>Implement Time Overlap Logic</name>
  <files>matriculaup_app/lib/utils/time_utils.dart, matriculaup_app/lib/store/schedule_state.dart</files>
  <action>
    Create a utility method `hasTimeConflict(Section newSection, List<CourseSelection> currentSchedule)` that returns true if any session in `newSection` overlaps with any session in the current schedule on the same day.
    Define overlap: time intervals intersect.
    Add a method to `ScheduleState` to expose this query: `bool conflictsWithSchedule(Section section)`.
  </action>
  <verify>Write or review simple unit tests/logic for time overlap (e.g., 10:30-12:30 vs 11:30-13:20).</verify>
  <done>Core business logic correctly identifies overlapping times.</done>
</task>

<task type="auto">
  <name>Visual Conflict Hints</name>
  <files>matriculaup_app/lib/ui/components/course_search_list.dart</files>
  <action>
    In the `CourseSearchList`, when rendering the list of sections for a course, use `state.conflictsWithSchedule(section)` to determine its visual state.
    If it conflicts, tint the row/text red or show a warning icon, indicating it will crash with the current schedule.
    Update the add button to optionally show a Snackbar "Esta sección tiene cruce de horarios" instead of silently dropping it, or block the add entirely.
  </action>
  <verify>Check the build method for conditional styling based on conflict state.</verify>
  <done>Sections that conflict are visibly marked in red before the user clicks them.</done>
</task>

</tasks>

<verification>
After tasks, verify:
- [ ] Adding a section of a course, then trying to add another section of the SAME course pops up a warning.
- [ ] Expanding a course that overlaps with the current grid shows the conflicting section highlighted in red.
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
