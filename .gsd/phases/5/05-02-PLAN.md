---
phase: 5
plan: 2
wave: 2
depends_on: ["05-01"]
files_modified: ["src/matriculaup/store/state.py", "src/matriculaup/ui/app_window.py", "src/matriculaup/ui/components/course_tree.py", "src/matriculaup/core/conflict_detector.py"]
autonomous: false
must_haves:
  truths:
    - "Users cannot add two sections of the same course"
    - "A visual indicator (e.g. red text or background) appears in the search tree if a section conflicts with the current schedule"
  artifacts:
    - "src/matriculaup/store/state.py"
    - "src/matriculaup/ui/components/course_tree.py"
---

# Plan 5.2: Duplicate Prevention & Visual Conflict Hints

<objective>
Actively prevent users from creating invalid schedules by blocking the addition of duplicate courses (different sections of the same course) and visually warning them of time conflicts in the search results *before* they try to add a course.
</objective>

<context>
Load for context:
- `src/matriculaup/store/state.py` (Where section adding logic lives)
- `src/matriculaup/ui/app_window.py` (Where connections between State and Tree will happen)
- `src/matriculaup/ui/components/course_tree.py` (Where visual hints need to be drawn)
- `src/matriculaup/core/conflict_detector.py` (Logic to check if a single section conflicts with a list of sections)
</context>

<tasks>

<task type="auto">
  <name>Prevent adding duplicate courses</name>
  <files>src/matriculaup/store/state.py</files>
  <action>
    Modify `ScheduleState.add_section` so that before appending a new section, it checks if ANY section with the same `course.codigo` already exists in `self.sections`. 
    If it does, it should refuse to add the new section.
    Optionally emit a new signal `error_emitted(str)` if it fails, so the UI can show a QMessageBox warning ("Ya tienes matriculado este curso en tu horario").
  </action>
  <verify>Check `add_section` logic in `state.py`.</verify>
  <done>The state gracefully rejects duplicate course codes and notifies the UI.</done>
</task>

<task type="auto">
  <name>Implement conflict pre-calculation method</name>
  <files>src/matriculaup/core/conflict_detector.py</files>
  <action>
    Add a new method `does_section_conflict(cls, course_section_to_check, current_schedule)` to `ConflictDetector`.
    This method should return a boolean (or the colliding course) indicating if the `course_section_to_check` overlaps with ANY session currently in `current_schedule`.
  </action>
  <verify>Verify `does_section_conflict` properly utilizes `sessions_overlap`.</verify>
  <done>Method exists and accurately detects conflicts against the current state.</done>
</task>

<task type="auto">
  <name>Add visual conflict hints to CourseTree</name>
  <files>src/matriculaup/ui/components/course_tree.py, src/matriculaup/ui/app_window.py</files>
  <action>
    Modify `CourseTree` to accept the `current_schedule` (or have a method to refresh the view based on current schedule).
    When populating the tree (`populate_tree`), for each `Section` item, use `ConflictDetector.does_section_conflict` against the current schedule.
    If it conflicts, change the row's text color to red (`QBrush(Qt.red)`) or add an "(Â¡Cruce!)" label.
    In `AppWindow`, whenever `self.state.on_sections_changed` fires, trigger a refresh of the `CourseTree` so the red hints update dynamically as the user builds their schedule.
  </action>
  <verify>Inspect `populate_tree` in `course_tree.py` for grid coloring logic and `AppWindow` for the update trigger.</verify>
  <done>Tree view dynamically highlights conflicting sections in red based on the live schedule.</done>
</task>

</tasks>

<verification>
After tasks, verify:
- [ ] Attempting to add a second section of the same course shows an error/does nothing.
- [ ] Adding a course updates the tree view, and any sections from other courses that overlap in time turn red.
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
